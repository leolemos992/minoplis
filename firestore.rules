/**
 * @fileoverview Firestore Security Rules for Localopoly.
 *
 * Core Philosophy:
 * This ruleset enforces a collaborative, game-centric security model.
 * Games are publicly readable, but only the host can manage the game itself.
 * Players can manage their own player data within a game.
 *
 * Data Structure:
 * - /games/{gameId}: Stores game metadata, accessible for public reading.
 * - /games/{gameId}/players/{playerId}: Stores individual player data within a specific game.
 *
 * Key Security Decisions:
 * - Games are publicly listable and readable to facilitate discovery.
 * - Player data is only modifiable by the corresponding player or the host of the game.
 * - The rules do not enforce a strict schema for rapid prototyping but do enforce authorization.
 *
 * Denormalization for Authorization:
 * - Player documents do not need to denormalize game information, as the host role is sufficient.
 *
 * Structural Segregation:
 * - The current design does not include segregation of public and private data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /games/{gameId} collection. Games are publicly readable, but create/update/delete are restricted to the host.
     * @path /games/{gameId}
     * @allow get, list: Any user can read game metadata.
     * @allow create: Only the authenticated user whose ID matches the 'hostId' field can create a game.
     * @allow update: Only the host of the game can update it.
     * @allow delete: Only the host of the game can delete it.
     * @principle Allows public read access to games while restricting write access to the host.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if isSignedIn() && isGameHost(gameId, request.auth.uid) && resource != null;
      allow delete: if isSignedIn() && isGameHost(gameId, request.auth.uid) && resource != null;
    }

    /**
     * @description Controls access to the /games/{gameId}/players/{playerId} subcollection. Players can only modify their own data, and the host can also modify player data.
     * @path /games/{gameId}/players/{playerId}
     * @allow get: Any authenticated user can read a player's data.
     * @allow list: Any authenticated user can list players in a game.
     * @allow create: Only authenticated user whose ID matches the 'userId' field can create a player.
     * @allow update: Only the player or the host of the game can update player data.
     * @allow delete: Only the player or the host of the game can delete player data.
     * @principle Enforces player-ownership for modifying player data within a game, with host override.
     */
    match /games/{gameId}/players/{playerId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (isPlayer(playerId, request.auth.uid) || isGameHost(gameId, request.auth.uid)) && resource != null;
      allow delete: if isSignedIn() && (isPlayer(playerId, request.auth.uid) || isGameHost(gameId, request.auth.uid)) && resource != null;
    }

    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the host of the game.
     * @param {string} gameId The ID of the game.
     * @param {string} userId The ID of the user.
     * @return {boolean} True if the user is the host of the game, false otherwise.
     */
    function isGameHost(gameId, userId) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.hostId == userId;
    }

    /**
     * @description Checks if the user is the player.
     * @param {string} playerId The ID of the player.
     * @param {string} userId The ID of the user.
     * @return {boolean} True if the user is the player, false otherwise.
     */
    function isPlayer(playerId, userId) {
      return playerId == userId;
    }
  }
}