/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based security model for the Localopoly application.
 *
 * Data Structure:
 * - /games/{gameId}: Represents a single game session.
 *   - /players/{playerId}: Represents a player within a game.
 *
 * Key Security Decisions:
 * - Games are publicly readable, but only the host can modify them.
 * - Players can only modify their own data within a game.
 * - Listing players within a game is restricted to authenticated users.
 *
 * Denormalization for Authorization:
 * - The `hostId` field is used on the `/games/{gameId}` document to easily authorize host-only operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the /games collection. Games are publicly readable, but only the host can modify them.
     * @path /games/{gameId}
     * @allow get, list: Any authenticated user can read game data.
     * @allow create: Only authenticated users can create games, and the hostId must match their UID.
     * @allow update, delete: Only the host of the game can update or delete it.
     * @deny create: A user cannot create a game with a hostId that doesn't match their own UID.
     * @deny update, delete: A non-host user cannot update or delete a game.
     * @principle Enforces public read access with owner-only writes for game management.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update, delete: if isExistingHost(gameId);
    }

    /**
     * @description Rules for the /games/{gameId}/players collection. Only the player or the host can modify player data.
     * @path /games/{gameId}/players/{playerId}
     * @allow get: Any authenticated user can read player data within a game.
     * @allow list: Any authenticated user can list players within a game.
     * @allow create: Only authenticated users can create player documents where the userId matches their UID.
     * @allow update, delete: Only the player or the host of the game can update or delete player data.
     * @deny create: A user cannot create a player with a userId that doesn't match their own UID.
     * @deny update, delete: A non-player/non-host user cannot update or delete player data.
     * @principle Enforces document ownership and shared access for player management.
     */
    match /games/{gameId}/players/{playerId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (isOwner(playerId) || isExistingHost(gameId));
    }

    // ---- Helper functions ----

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the host of the game.
     * @param {string} gameId - The ID of the game.
     */
    function isHost(gameId) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.hostId == request.auth.uid;
    }

      /**
       * @description Checks if the game exists and if the authenticated user is the host.
       * @param {string} gameId - The ID of the game.
       */
    function isExistingHost(gameId) {
          return isHost(gameId) && resource != null;
      }
  }
}