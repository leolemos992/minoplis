/**
 * @file Firebase Security Rules for Localopoly.
 *
 * @core_philosophy This ruleset prioritizes secure access control based on user roles and game ownership.
 *  It enforces a strict owner-only policy for game creation and deletion, while allowing more
 *  flexible read access. Data validation is minimized to facilitate rapid prototyping.
 *
 * @data_structure The data is organized hierarchically: `/games/{gameId}` contains game metadata,
 *  and subcollections `/games/{gameId}/players/{playerId}` and `/games/{gameId}/rolls-to-start/{playerId}` store player-specific data.
 *
 * @key_security_decisions
 *  - Only the host of a game can delete it.
 *  - Players can only modify their own data within a game.
 *  - Listing games is public, but creating them requires authentication.
 *
 * @denormalization_for_authorization
 *  - The `hostId` field on the `/games/{gameId}` document is used to authorize delete operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /games/{gameId} collection, where game metadata is stored.
     * @path /games/{gameId}
     * @allow (get, list): Any authenticated user can read basic game information.
     * @allow (create): Any authenticated user can create a new game. The 'hostId' field must match their UID.
     * @allow (update): No one can update the game document (only host can delete it).
     * @allow (delete): Only the host of the game can delete it.
     * @principle Enforces owner-only deletion and authenticated creation.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if false;
      allow delete: if isExistingOwner(resource.data.hostId);
    }

    /**
     * @description Controls access to the /games/{gameId}/players/{playerId} subcollection, where player-specific data is stored.
     * @path /games/{gameId}/players/{playerId}
     * @allow (get, list): No access to get or list all players.
     * @allow (create): No one can create a player document directly.
     * @allow (update): Only the player with a matching playerId can update their own document.
     * @allow (delete): No one can delete a player document.
     * @principle Enforces player-ownership for updates within a game.
     */
    match /games/{gameId}/players/{playerId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if isSignedIn() && isOwner(playerId) && resource != null;
      allow delete: if false;
    }

     /**
      * @description Controls access to the /games/{gameId}/rolls-to-start/{playerId} subcollection.
      * @path /games/{gameId}/rolls-to-start/{playerId}
      * @allow (get, list): No access to get or list all rolls.
      * @allow (create): Only the player with a matching playerId can create their own roll document.
      * @allow (update): No one can update a roll document.
      * @allow (delete): No one can delete a roll document.
      * @principle Enforces player-ownership for creating their own roll within a game.
      */
     match /games/{gameId}/rolls-to-start/{playerId} {
        allow get, list: if false;
        allow create: if isSignedIn() && isOwner(playerId);
        allow update: if false;
        allow delete: if false;
     }


    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}