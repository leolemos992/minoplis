/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a game-based authorization model for Localopoly.
 *
 * Data Structure:
 * - /games/{gameId}: Represents a single game session.
 *   - /games/{gameId}/players/{playerId}: Represents a player within the game.
 *
 * Key Security Decisions:
 * - Any authenticated user can list and read games.
 * - Only the player or the host can modify player data.
 * - Data validation is relaxed to allow for rapid prototyping. Only authorization-related fields are validated.
 * - Listing of player subcollections is restricted to the game host only.
 *
 * Denormalization for Authorization:
 * - The 'hostId' field on the /games/{gameId} document is used for authorization, avoiding the need for separate lookups.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /games collection. Games are publicly readable, but only the host can modify the game and players can modify their player data.
     * @path /games/{gameId}
     * @allow (get, list): Any authenticated user can read any game.
     * @allow (create): The user creating the game must be authenticated and set the hostId to their own UID.
     * @allow (update, delete): Only the host (creator) of the game can update or delete it.
     * @deny (create): If the hostId does not match the authenticated user's UID.
     * @deny (update, delete): If the request is not made by the host of the game.
     * @principle Allows public read access to game data while restricting write access to game data. Enforces data integrity by validating the hostId on creation.
     */
    match /games/{gameId} {
      // Anyone can read or list games
      allow get, list: if true;

      // Only the host can create the game, and the hostId must match their UID
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;

      // Only the host can update or delete the game
      allow update, delete: if isSignedIn() && isGameHost(gameId);

      /**
       * @description Controls access to the /players subcollection within a game. Players can only modify their own data. The game host can list all players.
       * @path /games/{gameId}/players/{playerId}
       * @allow (get): Any authenticated user can read any player's data within a game.
       * @allow (list): Only the host of the game can list players.
       * @allow (create): Creating a player document is disallowed. Players are automatically added to the game.
       * @allow (update): Only the player themselves can update their data.
       * @allow (delete): Deleting a player is disallowed. Players can only leave the game, not be deleted.
       * @deny (create, delete): Players can only be added and removed via game logic.
       * @deny (update): If the request is not made by the player themselves.
       * @principle Enforces player-ownership for modifying player data within a game. The game host can list all players.
       */
      match /players/{playerId} {
        // Anyone signed in can get player data
        allow get: if isSignedIn();

        // Only the host of the game can list players
        allow list: if isSignedIn() && isGameHost(gameId);

        // Players cannot be created or deleted directly
        allow create, delete: if false;

        // Only the player can update their own data
        allow update: if isSignedIn() && isOwner(playerId);
      }
    }
  }

  // --- Helper functions ---

  /**
   * @description Checks if the user is signed in.
   * @return {bool} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the resource.
   * @param {string} userId The user ID to compare against the request's auth UID.
   * @return {bool} True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  /**
   * @description Checks if the user is the owner of the resource and the resource exists.
   * @param {string} resourceId The resource ID to compare against the request's auth UID.
   * @param {string} ownerId The owner id of the resource.
   * @return {bool} True if the user is the owner and the resource exists, false otherwise.
   */
  //function isExistingOwner(resourceId, ownerId) {
  //  return isOwner(ownerId) && resource != null;
  //}

    /**
   * @description Checks if the current user is the host of the game.
   * @param {string} gameId The ID of the game.
   * @return {bool} True if the user is the host, false otherwise.
   */
  function isGameHost(gameId) {
    return get(/databases/$(database)/documents/games/$(gameId)).data.hostId == request.auth.uid;
  }
}