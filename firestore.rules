/**
 * @fileoverview Firestore Security Rules for Localopoly.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of public read access for game listings and strict user-ownership for player data within a game.
 *
 * Data Structure:
 * - /games/{gameId}: Stores game metadata, readable by all.
 * - /games/{gameId}/players/{playerId}: Stores individual player data, writable only by the player.
 * - /games/{gameId}/rolls-to-start/{playerId}: Stores roll to start data, writable only by the player.
 *
 * Key Security Decisions:
 * - Games are publicly listable to facilitate discovery.
 * - Players can only modify their own data within a game.
 * - Data validation is relaxed to allow for rapid prototyping. Authorization is strictly enforced.
 * - Owner-only writes are enforced by validating that an `ownerId` field exists on the document and matches the user's `auth.uid`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read game data, but restricts game creation, updates, and deletion to the host.
     * @path /games/{gameId}
     * @allow (get, list) Anyone can read game data.
     * @allow (create) User with auth.uid 'user_abc' can create a game with hostId: 'user_abc'.
     * @allow (update) User with auth.uid 'user_abc' can update a game where resource.data.hostId == 'user_abc'.
     * @allow (delete) User with auth.uid 'user_abc' can delete a game where resource.data.hostId == 'user_abc'.
     * @deny (create) User with auth.uid 'user_xyz' cannot create a game with hostId: 'user_abc'.
     * @deny (update) User with auth.uid 'user_xyz' cannot update a game where resource.data.hostId == 'user_abc'.
     * @deny (delete) User with auth.uid 'user_xyz' cannot delete a game where resource.data.hostId == 'user_abc'.
     * @principle Allows public read access to games while enforcing owner-only write access.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/games/$(gameId)).data.hostId == request.auth.uid;
    }

    /**
     * @description Allows a player to read and write their own data within a game.
     * @path /games/{gameId}/players/{playerId}
     * @allow (get, list) User with auth.uid 'user_abc' can read a player document with userId: 'user_abc'.
     * @allow (create) User with auth.uid 'user_abc' can create a player document with userId: 'user_abc'.
     * @allow (update) User with auth.uid 'user_abc' can update their own player document.
     * @allow (delete) User with auth.uid 'user_abc' can delete their own player document.
     * @deny (create) User with auth.uid 'user_xyz' cannot create a player document with userId: 'user_abc'.
     * @deny (update) User with auth.uid 'user_xyz' cannot update a player document with userId: 'user_abc'.
     * @deny (delete) User with auth.uid 'user_xyz' cannot delete a player document with userId: 'user_abc'.
     * @principle Enforces strict ownership of player data within a game.
     */
    match /games/{gameId}/players/{playerId} {
      allow get, list: if isSignedIn() && request.auth.uid == playerId;
      allow create: if isSignedIn() && request.auth.uid == playerId;
      allow update: if isSignedIn() && request.auth.uid == playerId;
      allow delete: if isSignedIn() && request.auth.uid == playerId;
    }

    /**
     * @description Allows a player to read and write their own roll-to-start data within a game.
     * @path /games/{gameId}/rolls-to-start/{playerId}
     * @allow (get, list) User with auth.uid 'user_abc' can read a roll-to-start document with playerId: 'user_abc'.
     * @allow (create) User with auth.uid 'user_abc' can create a roll-to-start document with playerId: 'user_abc'.
     * @allow (update) User with auth.uid 'user_abc' can update their own roll-to-start document.
     * @allow (delete) User with auth.uid 'user_abc' can delete their own roll-to-start document.
     * @deny (create) User with auth.uid 'user_xyz' cannot create a roll-to-start document with playerId: 'user_abc'.
     * @deny (update) User with auth.uid 'user_xyz' cannot update a roll-to-start document with playerId: 'user_abc'.
     * @deny (delete) User with auth.uid 'user_xyz' cannot delete a roll-to-start document with playerId: 'user_abc'.
     * @principle Enforces strict ownership of roll-to-start data within a game.
     */
    match /games/{gameId}/rolls-to-start/{playerId} {
      allow get, list: if isSignedIn() && request.auth.uid == playerId;
      allow create: if isSignedIn() && request.auth.uid == playerId;
      allow update: if isSignedIn() && request.auth.uid == playerId;
      allow delete: if isSignedIn() && request.auth.uid == playerId;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // The following functions are no longer needed due to the direct checks in the rules
  // function isExistingOwner(documentId, ownerId) {
  //   return isSignedIn() && isOwner(ownerId) && resource != null;
  // }

  // function isExistingOwner(documentId) {
  //   return isSignedIn() && isOwner(documentId) && resource != null;
  // }
}