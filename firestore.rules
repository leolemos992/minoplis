/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a game-centric access control model for Localopoly, focusing on user authentication and game-specific permissions.
 *
 * Data Structure:
 * - /games/{gameId}: Stores game session data.  Any authenticated user can read game details.
 * - /games/{gameId}/players/{playerId}: Stores player-specific data within a game. Players can only modify their own data, and the game host has broader access.
 *
 * Key Security Decisions:
 * - Authenticated users can list games.
 * - Players are only allowed to modify their own player document within a game.
 * - The game host has elevated privileges over the game document and potentially player documents (not explicitly defined in provided documents).
 *
 * Denormalization for Authorization:
 * - The 'Game' entity includes a 'hostId' field which is used to determine the game host.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to read game data and enforces host-based control for modifications.
     * @path /games/{gameId}
     * @allow (get, list): Any authenticated user can read and list games.
     * @allow (create): Any authenticated user can create a game. The 'hostId' field must match the user's UID.
     * @allow (update, delete): Only the game host (identified by 'hostId') can update or delete the game.
     * @deny (create): If the 'hostId' field does not match the user's UID.
     * @deny (update, delete): If the user is not the game host.
     * @principle Allows public reads, restricts writes to the game host, and validates ownership on create.
     */
    match /games/{gameId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.hostId);
      allow delete: if isExistingOwner(resource.data.hostId);
    }

    /**
     * @description Enforces player-specific data access within a game.
     * @path /games/{gameId}/players/{playerId}
     * @allow (get, list): Any authenticated user can read the list of players in a game.
     * @allow (create): Only the user with the matching playerId can create a player document, ensuring a user can only create their own player profile.
     * @allow (update, delete): Only the player with the matching 'userId' or the host of the game can update or delete the player's data.
     * @deny (create): If the 'playerId' does not match the user's UID.
     * @deny (update, delete): If the user is not the player or the host of the game.
     * @principle Enforces player ownership for data modifications within a game context and allows game hosts to manage players (not fully implemented due to lack of host role enforcement on player documents).
     */
    match /games/{gameId}/players/{playerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (isPlayerOwner(resource.data.userId) || isGameHost(gameId));
      allow delete: if isSignedIn() && (isPlayerOwner(resource.data.userId) || isGameHost(gameId));
    }

    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the document and the document exists.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is the owner of the player document.
     * @param {string} playerUserId The player's user ID to compare with the request's auth UID.
     * @returns {boolean} True if the user is the owner of the player document, false otherwise.
     */
    function isPlayerOwner(playerUserId) {
      return request.auth.uid == playerUserId;
    }

    /**
     * @description Checks if the user is the host of the game.
     * @param {string} gameId The ID of the game.
     * @returns {boolean} True if the user is the host of the game, false otherwise.
     */
    function isGameHost(gameId) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.hostId == request.auth.uid;
    }
  }
}