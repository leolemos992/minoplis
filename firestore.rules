/**
 * @fileOverview Firestore Security Rules for Minoplis.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for games, where the creator (host) has certain privileges.
 * Players can update their own player data within a game.
 *
 * Data Structure:
 * Games are stored in the `/games/{gameId}` collection.
 * Each game has a subcollection `/games/{gameId}/players/{playerId}` storing player data.
 *
 * Key Security Decisions:
 * - Any autheticated user can create a game.
 * - Games are readable to anyone.
 * - Only the host of a game can update/delete it (not yet implemented).
 * - Players can only update their own data within a game.
 * - Listing all games or players is allowed for now.
 *
 * Denormalization for Authorization:
 * - The `Game` document includes a `hostId` field to identify the game creator. This allows rules to quickly check ownership without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the /games collection.
     * @path /databases/{database}/documents/games/{gameId}
     * @allow (create) Authenticated user can create a new game.
     * @allow (get, list) Any user can read game details and list all games.
     * @deny (update, delete) Only the game host can update or delete the game (not yet implemented).
     * @principle Allows any authenticated user to create games, read access to everyone.
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update, delete: if false; // TODO: Implement host-only update/delete after host-based update function is created

       /**
        * @description Rules for the /games/{gameId}/players collection.
        * @path /databases/{database}/documents/games/{gameId}/players/{playerId}
        * @allow (create) Any authenticated user can create their own player entry within a game.
        * @allow (get, list) Any user can read and list player details within a game.
        * @allow (update) Players can only update their own player data.
        * @deny (delete) No one can delete player documents directly.
        * @principle Enforces player-ownership for updates within a game.
        */
      match /players/{playerId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == playerId;
        allow update: if isSignedIn() && request.auth.uid == playerId && resource != null;
        allow delete: if false;
      }
    }

    function isSignedIn() {
      return request.auth != null;
    }

  }
}