/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for the MINOPLIS game.
 *
 * Data Structure:
 * - /games/{gameId}: Stores game metadata.
 * - /games/{gameId}/players/{playerId}: Stores player-specific data within a game.
 *
 * Key Security Decisions:
 * - Publicly readable games list (for discovery), but create/update/delete operations are restricted to the game host.
 * - Players can only manage their own player documents.
 * - The `hostId` field in the `/games/{gameId}` document is used to control administrative access to the game.
 *
 * Denormalization for Authorization:
 * - The `hostId` is denormalized onto the `Game` document to allow efficient access control.
 *
 * Structural Segregation:
 * - Game and player data are stored in separate collections for clarity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /games/{gameId} collection.
     * @path /games/{gameId}
     * @allow (get, list): Any user can read game data to discover available games.
     * @allow (create): Authenticated user can create a game if they set themselves as the host.
     * @allow (update, delete): Only the game host can modify or delete a game.
     * @deny (create): An unauthenticated user cannot create a game.
     * @deny (update, delete): A non-host user cannot modify or delete a game.
     * @principle Public read access for game discovery, owner-only writes for game management.
     */
    match /games/{gameId} {
      allow get, list: if true; // Public read access for game discovery

      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update, delete: if isExistingOwner(resource.data.hostId);

    }

    /**
     * @description Controls access to the /games/{gameId}/players/{playerId} subcollection.
     * @path /games/{gameId}/players/{playerId}
     * @allow (get, list): Any authenticated user can read player data within a game.
     * @allow (create, update): A player can only create or update their own player document.
     * @deny (create, update, delete): A player cannot create, update, or delete another player's document.
     * @principle Enforces document ownership for player data.
     */
    match /games/{gameId}/players/{playerId} {
      allow get, list: if isSignedIn(); //Any logged in user can see the players in a game

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid; //A user can create their own player if logged in.
      allow update: if isExistingOwner(resource.data.userId) ; //A user can only update their own player
      allow delete: if false; // No one can delete a player object.
    }

    /**
     * Function to check if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource, and that the resource exists.
     * @param {string} userId The ID of the user to check for ownership.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && request.auth.uid == userId && resource != null;
    }
  }
}