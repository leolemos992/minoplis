/**
 * @file Firebase Security Rules for Localopoly.
 *
 * @core_philosophy This ruleset prioritizes secure access control based on user identity and game ownership.
 *  It allows authenticated users to list games, but restricts modification of game data and player data to authorized users only.
 *  The ruleset defaults to strict access control, explicitly denying any access not specifically granted.
 *
 * @data_structure
 * - /games/{gameId}: Stores game metadata.
 * - /games/{gameId}/players/{playerId}: Stores player-specific data within a game.
 * - /games/{gameId}/rolls-to-start/{playerId}: Stores roll-to-start data for each player in a game.
 *
 * @key_security_decisions
 * - Listing of games is public to authenticated users.
 * - Modification of games is limited to the host.
 * - Player data modification is limited to the player themselves.
 * - User listing is disabled to prevent information disclosure.
 *
 * @denormalization_for_authorization
 *  The `hostId` field is used within the game document to determine who can update or delete the game.
 *  Player documents have a `userId` field which is used to match against `request.auth.uid` to ensure that only the player can modify their own data.
 *
 * @structural_segregation N/A (no public/private separation).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner (host) of the game.
     */
    function isOwner(hostId) {
        return isSignedIn() && request.auth.uid == hostId;
    }

    /**
     * @description Checks if the authenticated user is the owner (host) of the game and the resource exists.
     */
    function isExistingOwner(hostId) {
        return isOwner(hostId) && resource != null;
    }

    /**
     * @description Rules for the /games collection.
     * @path /games/{gameId}
     * @allow (list) Signed-in user can list games.
     * @deny (create) Non-signed-in user cannot create games.
     * @principle Allows listing for authenticated users. Enforces game ownership for writes.
     */
    match /games/{gameId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.hostId);
      allow delete: if isExistingOwner(resource.data.hostId);
    }

    /**
     * @description Rules for the /games/{gameId}/players collection.
     * @path /games/{gameId}/players/{playerId}
     * @allow (create) Signed-in user can create their own player document in the game.
     * @deny (update) Signed-in user cannot modify another player's document.
     * @principle Enforces player ownership for writes.
     */
    match /games/{gameId}/players/{playerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }

    /**
     * @description Rules for the /games/{gameId}/rolls-to-start collection.
     * @path /games/{gameId}/rolls-to-start/{playerId}
     * @allow (create) Signed-in user can create their roll to start document.
     * @deny (update) No one can update a roll to start after it's created.
     */
    match /games/{gameId}/rolls-to-start/{playerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}