/**
 * @fileoverview Firestore Security Rules for Localopoly.
 *
 * Core Philosophy:
 * This ruleset prioritizes user-level access control and data integrity. It uses
 * a combination of ownership-based and role-based access control to secure
 * data. Data shape validation is relaxed to allow for rapid prototyping and
 * iteration.
 *
 * Data Structure:
 * - /games/{gameId}: Represents a single Localopoly game session.
 *   - /players/{playerId}: Represents a player within a game.
 *   - /rolls-to-start/{playerId}: Stores roll-to-start results.
 *
 * Key Security Decisions:
 * - Games can be read by anyone, but only the host can modify them.
 * - Players can only modify their own player data within a game.
 *
 * Denormalization for Authorization:
 * The `hostId` field is denormalized on the `/games/{gameId}` document to allow
 * for efficient ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the /games collection.
     * @path /games/{gameId}
     * @allow (get, list) Any authenticated user can read game data.
     * @allow (create) Only authenticated users can create a game with their user ID as the hostId.
     * @allow (update, delete) Only the host of the game can update or delete the game.
     * @deny (create) If the hostId in the request does not match the authenticated user's ID.
     * @deny (update, delete) If the game does not exist.
     * @principle Enforces game host ownership for write operations. Allows public read access.
     */
    match /games/{gameId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isHost() {
        return isSignedIn() && getSelf().data.hostId == request.auth.uid;
      }

      function getSelf() {
        return get(request.path);
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.hostId == request.auth.uid;
      allow update, delete: if isSignedIn() && isHost();
    }

    /**
     * @description Rules for the /games/{gameId}/players collection.
     * @path /games/{gameId}/players/{playerId}
     * @allow (get, list) Not applicable (read operations should be done at document level)
     * @allow (create) Any authenticated user can create their own player document under a game
     * @allow (update) Only the player themselves can update their data.
     * @allow (delete) No one can delete a player, only the app
     * @deny (create) If the playerId does not match the authenticated user's ID.
     * @deny (update) If the player does not exist.
     * @principle Enforces player ownership for write operations.
     */
    match /games/{gameId}/players/{playerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && request.auth.uid == playerId;
      }


      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == playerId;
      allow update: if isSignedIn() && isOwner();
      allow delete: if false;
    }

    /**
     * @description Rules for the /games/{gameId}/rolls-to-start collection.
     * @path /games/{gameId}/rolls-to-start/{playerId}
     * @allow (get, list) Not applicable (read operations should be done at document level)
     * @allow (create) Any authenticated user can create their own roll-to-start document under a game
     * @allow (update, delete) Not allowed
     * @deny (create) If the playerId does not match the authenticated user's ID.
     * @principle Enforces player ownership for write operations.
     */
    match /games/{gameId}/rolls-to-start/{playerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return isSignedIn() && request.auth.uid == playerId;
      }

      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == playerId;
      allow update: if false;
      allow delete: if false;
    }
  }
}